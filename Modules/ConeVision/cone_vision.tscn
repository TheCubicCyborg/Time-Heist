[gd_scene format=3 uid="uid://dyhnk6p2fbc87"]

[sub_resource type="GDScript" id="GDScript_23e0v"]
resource_name = "cone_vision"
script/source = "@tool
extends Area3D

var player_spotted
@onready var sight_checker := $SightChecker
@onready var collision := $CollisionPolygon3D
@onready var laser: MeshInstance3D = $Laser
@onready var laser_mesh: ImmediateMesh = laser.mesh

var time_detecting: float = 0

@export var sight_line_angle : float = 130: #degrees
	set(value):
		sight_line_angle = value
		create_mesh()
@export var sight_line_radius : float = 15: #meters
	set(value):
		sight_line_radius = value
		create_mesh()
@export var smaller_sight_line_radius : float = 5: #meters
	set(value):
		smaller_sight_line_radius = value
		create_mesh()
@export var time_till_caught : float = 1
@export var angle_steps : float = 5:
	set(value):
		angle_steps = value
		create_mesh()

var polygon_points : PackedVector2Array = []

func _ready() -> void:
	if not Engine.is_editor_hint():
		globals.safe_ratio = 1
		#Set ray cast length
		sight_checker.target_position.z = -sight_line_radius
		
		create_mesh()
		collision.polygon = polygon_points

func create_mesh():
	var rest_of_sweep = 360 - sight_line_angle
	polygon_points = []
	#polygon_points.append(Vector2.ZERO)
	var sweep_angle = -sight_line_angle / 2
	var rest_of_sweep_angle = -rest_of_sweep / 2
	
	for j in range(sight_line_angle / angle_steps + 1):
		polygon_points.append(Vector2(
			-sight_line_radius * sin(deg_to_rad(sweep_angle)),
			sight_line_radius * cos(deg_to_rad(sweep_angle))
		))
		sweep_angle += angle_steps
	for i in range(rest_of_sweep / angle_steps + 1):
		polygon_points.append(Vector2(
			smaller_sight_line_radius * sin(deg_to_rad(rest_of_sweep_angle)),
			-smaller_sight_line_radius * cos(deg_to_rad(rest_of_sweep_angle))
		))
		rest_of_sweep_angle += angle_steps
	if Engine.is_editor_hint():	
		collision.polygon = polygon_points
	
func _process(delta: float) -> void:
	#print(timer.time_left)
	if not Engine.is_editor_hint():
		if player_spotted:
			sight_checker.look_at(Vector3(globals.player.global_position.x,1,globals.player.global_position.z))
			#laser.curve.set_point_in(1,Vector3(globals.player.global_position.x,1,globals.player.global_position.z))
			
			if sight_checker.get_collider() == globals.player:
				time_detecting += delta
				laser_mesh.clear_surfaces()
				draw_line()
			else:
				time_detecting = 0
				laser_mesh.clear_surfaces()
			globals.safe_ratio = (time_till_caught-time_detecting)/time_till_caught
			
			if time_detecting >= time_till_caught:
				caught()
				
			
	

func _on_body_entered(body: Node3D) -> void:
	if body == globals.player:
		player_spotted = true
		
func _on_body_exited(body: Node3D) -> void:
	if body == globals.player:
		player_spotted = false 
		time_detecting = 0
		globals.safe_ratio = (time_till_caught-time_detecting)/time_till_caught
		laser_mesh.clear_surfaces()
	
func caught() -> void:
	globals.player_caught()

func draw_line():
	var start_point = Vector3.ZERO  # local origin of the laser node
	var end_point = to_local(globals.player.global_position) + Vector3(0, 0.5, 0) # if you want y=1 offset
	# Begin drawing the line
	laser_mesh.surface_begin(Mesh.PRIMITIVE_LINES)
	laser_mesh.surface_set_color(Color(1.0, 0.376, 0.308, 1.0))
	# Add the vertices
	laser_mesh.surface_add_vertex(start_point)
	laser_mesh.surface_add_vertex(end_point)
	# Finish drawing
	laser_mesh.surface_end()
"

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_23e0v"]
vertex_color_use_as_albedo = true

[sub_resource type="ImmediateMesh" id="ImmediateMesh_23e0v"]

[node name="Cone Vision" type="Area3D" unique_id=1869490121]
script = SubResource("GDScript_23e0v")

[node name="CollisionPolygon3D" type="CollisionPolygon3D" parent="." unique_id=955152349]
transform = Transform3D(1, 0, 0, 0, -4.371139e-08, -1, 0, 1, -4.371139e-08, 0, 0, 0)
polygon = PackedVector2Array(13.594617, 6.339274, 12.990381, 7.5, 12.287281, 8.603646, 11.490666, 9.641814, 10.606602, 10.606602, 9.641814, 11.490666, 8.603646, 12.287281, 7.5, 12.990381, 6.339274, 13.594617, 5.130302, 14.095389, 3.8822856, 14.488888, 2.6047227, 14.772117, 1.3073361, 14.942921, 0, 15, -1.3073361, 14.942921, -2.6047227, 14.772117, -3.8822856, 14.488888, -5.130302, 14.095389, -6.339274, 13.594617, -7.5, 12.990381, -8.603646, 12.287281, -9.641814, 11.490666, -10.606602, 10.606602, -11.490666, 9.641814, -12.287281, 8.603646, -12.990381, 7.5, -13.594617, 6.339274, -4.531539, 2.1130912, -4.698463, 1.7101008, -4.829629, 1.2940953, -4.924039, 0.8682409, -4.9809737, 0.4357787, -5, -3.061617e-16, -4.9809737, -0.4357787, -4.924039, -0.8682409, -4.829629, -1.2940953, -4.698463, -1.7101008, -4.531539, -2.1130912, -4.3301272, -2.5, -4.0957603, -2.8678823, -3.8302221, -3.213938, -3.535534, -3.535534, -3.213938, -3.8302221, -2.8678823, -4.0957603, -2.5, -4.3301272, -2.1130912, -4.531539, -1.7101008, -4.698463, -1.2940953, -4.829629, -0.8682409, -4.924039, -0.4357787, -4.9809737, 0, -5, 0.4357787, -4.9809737, 0.8682409, -4.924039, 1.2940953, -4.829629, 1.7101008, -4.698463, 2.1130912, -4.531539, 2.5, -4.3301272, 2.8678823, -4.0957603, 3.213938, -3.8302221, 3.535534, -3.535534, 3.8302221, -3.213938, 4.0957603, -2.8678823, 4.3301272, -2.5, 4.531539, -2.1130912, 4.698463, -1.7101008, 4.829629, -1.2940953, 4.924039, -0.8682409, 4.9809737, -0.4357787, 5, -3.061617e-16, 4.9809737, 0.4357787, 4.924039, 0.8682409, 4.829629, 1.2940953, 4.698463, 1.7101008, 4.531539, 2.1130912)
debug_color = Color(0.9529412, 0.16862746, 0.3647059, 1)

[node name="SightChecker" type="RayCast3D" parent="." unique_id=716854366]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0)
target_position = Vector3(0, 0, -50)
collision_mask = 9

[node name="Laser" type="MeshInstance3D" parent="." unique_id=836442765]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.7, 0)
material_override = SubResource("StandardMaterial3D_23e0v")
mesh = SubResource("ImmediateMesh_23e0v")

[connection signal="body_entered" from="." to="." method="_on_body_entered"]
[connection signal="body_exited" from="." to="." method="_on_body_exited"]
